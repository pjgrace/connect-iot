<?xml version="1.0"?>
<pattern  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

    <patterndata>
        <data>
            <name>token</name>
            <value>**TOKEN**</value>
        </data>
    </patterndata>
    
    <architecture>
        <component>
            <id>pubsubGE</id>
            <address>**ADDRESS**</address>
            <interface>
                <id>NGSI9</id>
                <url>**URL**</url>
            </interface>
        </component>
    </architecture>
    
     <behaviour>
        <state>
          <label>B1</label>
          <type>triggerstart</type>
          <transition>    
                <to>B2</to>
                <message>
                    <url>component.pubsubGE.NGSI9</url>
                    <path>/registerContext</path>
                    <method>post</method>
                    <type>xml</type>
                    <headers>
                        <header>
                            <name>X-Auth-Token</name>
                            <value>patterndata.token</value>
                        </header>
                    </headers>
                    <body><![CDATA[<registerContextRequest>
                        <contextRegistrationList>
                          <contextRegistration>
                            <entityIdList>
                              <entityId type="Car" isPattern="false">
                                <id>Ford1</id>
                              </entityId>
                              <entityId type="Room" isPattern="false">
                                <id>Ford2</id>
                              </entityId>
                            </entityIdList>
                            <contextRegistrationAttributeList>
                              <contextRegistrationAttribute>
                                <name>temperature</name>
                                <type>centigrade</type>
                                <isDomain>false</isDomain>
                              </contextRegistrationAttribute>
                              <contextRegistrationAttribute>
                                <name>pressure</name>
                                <type>mmHg</type>
                                <isDomain>false</isDomain>
                              </contextRegistrationAttribute>
                            </contextRegistrationAttributeList>
                            <providingApplication>http://mysensors.com/Cars</providingApplication>
                        </contextRegistration>
                        </contextRegistrationList>
                        <duration>P1M</duration>
                      </registerContextRequest>]]>
                    </body>
                </message>
              </transition>
        </state>

        <state>
          <label>B2</label>
          <type>normal</type>
            <transition>    
                <to>B3</to>
                <guards>
                    <equal>
                        <param>HTTP.from</param>
                        <value>component.pubsubGE.address</value>
                    </equal>
                    <equal>
                        <param>HTTP.msg</param>
                        <value>REPLY</value>
                    </equal>
                    <equal>
                        <param>HTTP.Code</param>
                        <value>200</value>
                    </equal>
                    <equal>
                        <param>Content[name(/*)]</param>
                        <value>registerContextResponse</value>
                    </equal>
                    <equal>
                        <param>Content[/registerContextResponse/duration/text()]</param>
                        <value>P1M</value>
                    </equal>
                </guards>
              </transition>
        </state>
        <state>
          <label>B3</label>
          <type>trigger</type>
          <transition>    
                <to>B4</to>
                <message>
                    <url>component.pubsubGE.NGSI9</url>
                    <path>/discoverContextAvailability</path>
                    <method>post</method>
                    <type>xml</type>
                    <headers>
                        <header>
                            <name>X-Auth-Token</name>
                            <value>patterndata.token</value>
                        </header>
                    </headers>
                    <body><![CDATA[<?xml version="1.0"?>
                        <discoverContextAvailabilityRequest>
                          <entityIdList>
                            <entityId type="Car" isPattern="false">
                              <id>Ford1</id>
                            </entityId>
                          </entityIdList>
                          <attributeList/>
                        </discoverContextAvailabilityRequest>]]>
                    </body>
                </message>
              </transition>
        </state>

        <state>
          <label>B4</label>
          <type>normal</type>
            <transition>    
                <to>B5</to>
                <guards>
                    <equal>
                        <param>HTTP.from</param>
                        <value>component.pubsubGE.address</value>
                    </equal>
                    <equal>
                        <param>HTTP.msg</param>
                        <value>REPLY</value>
                    </equal>
                    <equal>
                        <param>HTTP.Code</param>
                        <value>200</value>
                    </equal>
                    <equal>
                        <param>Content[name(/*)]</param>
                        <value>discoverContextAvailabilityResponse</value>
                    </equal>
                    <equal>
                        <param>Content[/discoverContextAvailabilityResponse/contextRegistrationResponseList/contextRegistrationResponse/contextRegistration/entityIdList/entityId/Id/text()]</param>
                        <value>Ford1</value>
                    </equal>
                </guards>
              </transition>
        </state>
        <state>
          <label>B5</label>
          <type>trigger</type>
          <transition>    
                <to>B6</to>
                <message>
                    <url>component.pubsubGE.NGSI9</url>
                    <path>/subscribeContextAvailability</path>
                    <method>post</method>
                    <type>xml</type>
                    <headers>
                        <header>
                            <name>X-Auth-Token</name>
                            <value>patterndata.token</value>
                        </header>
                    </headers>
                    <body><![CDATA[<?xml version="1.0"?>
                        <subscribeContextAvailabilityRequest>
                          <entityIdList>
                            <entityId type="Car" isPattern="true">
                              <id>.*</id>
                            </entityId>
                          </entityIdList>
                          <attributeList>
                            <attribute>temperature</attribute>
                          </attributeList>
                          <reference>http://localhost:1028/accumulate</reference>
                          <duration>P1M</duration>
                        </subscribeContextAvailabilityRequest>]]>
                    </body>
                </message>
              </transition>
        </state>

        <state>
          <label>B6</label>
          <type>normal</type>
            <transition>    
                <to>B7</to>
                <guards>
                    <equal>
                        <param>HTTP.from</param>
                        <value>component.pubsubGE.address</value>
                    </equal>
                    <equal>
                        <param>HTTP.msg</param>
                        <value>REPLY</value>
                    </equal>
                    <equal>
                        <param>HTTP.Code</param>
                        <value>200</value>
                    </equal>
                    <equal>
                        <param>Content[name(/*)]</param>
                        <value>subscribeContextAvailabilityResponse</value>
                    </equal>
                    <equal>
                        <param>Content[/subscribeContextAvailabilityResponse/duration/text()]</param>
                        <value>P1M</value>
                    </equal>
                </guards>
              </transition>
        </state>
        <state>
          <label>B7</label>
          <type>trigger</type>
          <transition>    
                <to>B8</to>
                <message>
                    <url>component.pubsubGE.NGSI9</url>
                    <path>/unsubscribeContextAvailability </path>
                    <method>post</method>
                    <type>xml</type>
                    <headers>
                        <header>
                            <name>X-Auth-Token</name>
                            <value>patterndata.token</value>
                        </header>
                    </headers>
                    <body><![CDATA[<?xml version="1.0"?>
                        <unsubscribeContextAvailabilityRequest>
                          <subscriptionId>$$B6|content|/subscribeContextAvailabilityResponse/subscriptionId/text()$$</subscriptionId>
                        </unsubscribeContextAvailabilityRequest>]]>
                    </body>
                </message>
              </transition>
        </state>

        <state>
          <label>B8</label>
          <type>normal</type>
            <transition>    
                <to>B99</to>
                <guards>
                    <equal>
                        <param>HTTP.from</param>
                        <value>component.pubsubGE.address</value>
                    </equal>
                    <equal>
                        <param>HTTP.msg</param>
                        <value>REPLY</value>
                    </equal>
                    <equal>
                        <param>HTTP.Code</param>
                        <value>200</value>
                    </equal>
                    <equal>
                        <param>Content[name(/*)]</param>
                        <value>unsubscribeContextAvailabilityResponse</value>
                    </equal>
                    <equal>
                        <param>Content[/unsubscribeContextAvailabilityResponse/statusCode/code/text()]</param>
                        <value>200</value>
                    </equal>
                </guards>
              </transition>
        </state>  
        <state>
            <label>B99</label>
            <type>end</type>
        </state>
    </behaviour>

</pattern>
